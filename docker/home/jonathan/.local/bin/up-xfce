#!/bin/bash

if [ -z $(pidof xfce4-session) ]; then

    # Declare constants
    WIN_HOME=/mnt/c/Users/Jonathan
    APPLICATIONS=${WIN_HOME}/Applications
    APP_DIR=${APPLICATIONS}/Fedora

    # Set environment
    export HOST_IP=$(ip route list default | awk '{print $3}')
    export DISPLAY=$HOST_IP:0
    export PULSE_SERVER=tcp:$HOST_IP

    # NOTE: Fix a bug with compositing not loading correctly, symptom is choppy desktop UI (it initializes as expected tho)
    xfwm4_config="${HOME}/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml"
    [ -f "$xfwm4_config" ] && sed -i '/property name=\"use_compositing\"/d' "$xfwm4_config"

    # Evade UNC complaints
    [ ! -f "${APP_DIR}/xfce.xlaunch" ] && cp ${HOME}/.local/bin/xfce.xlaunch ${APP_DIR}/
    cd $APP_DIR

    # Start x-server
    cmd.exe /c '.\xfce.xlaunch'
    cmd.exe /c 'C:\pulseaudio\bin\pulseaudio.exe' &

    # Enforce ~ as working directory for xfce-session (rationale: makes new terminal sessions more comfortable)
    # NOTE: Do NOT start in background (desired behavior: cleanup logic will run when user logs out)
    cd "$HOME" && startxfce4

    # Cleanup
    pkill '(gpg|ssh)-agent'
    taskkill.exe /IM pulseaudio.exe /F
    taskkill.exe /IM vcxsrv.exe /F

fi
